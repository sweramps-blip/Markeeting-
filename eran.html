<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Power Star | Official</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --p: #d4ff00; --bg: #0a0e1a; --c: #151b2d; --text: #94a3b8; }
        * { box-sizing: border-box; }
        body { 
            font-family: 'Outfit', sans-serif; 
            background: var(--bg); 
            color: #fff; 
            margin: 0; 
            padding: 10px; 
            padding-bottom: 70px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
        }
        
        .card { 
            background: #151b2d; 
            padding: 25px; 
            border-radius: 20px; 
            width: 100%; 
            max-width: 380px; 
            border: 1px solid #2a344d; 
            margin-bottom: 15px; 
        }
        
        /* SCREENS - Only one visible at a time */
        .screen { display: none; width: 100%; max-width: 380px; }
        .screen.active { display: block; }

        /* REGISTRATION SCREEN */
        .reg-header { text-align: center; margin-bottom: 20px; }
        .reg-header h1 { font-size: 26px; color: var(--p); margin: 0 0 8px 0; font-weight: 800; }
        .reg-header p { color: var(--text); font-size: 13px; margin: 0; }
        
        .info-box { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            padding: 18px; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            text-align: center; 
        }
        .info-box p { color: white; font-size: 13px; margin: 5px 0; line-height: 1.6; }
        .info-box b { color: var(--p); }
        
        input { 
            width: 100%; 
            padding: 14px; 
            margin: 8px 0; 
            border-radius: 12px; 
            border: 1px solid #2a344d; 
            background: #0a0e1a; 
            color: #fff; 
            font-size: 14px; 
        }
        input:focus { outline: none; border-color: var(--p); }
        
        .file-box { 
            border: 2px dashed #2a344d; 
            padding: 15px; 
            border-radius: 12px; 
            margin: 10px 0; 
            background: rgba(255,255,255,0.02); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            gap: 12px; 
        }
        .file-info { flex: 1; display: flex; align-items: center; gap: 10px; }
        .file-info i { font-size: 28px; color: var(--p); }
        #fileName { color: var(--text); font-size: 13px; }
        .upload-btn { 
            background: var(--p); 
            color: #000; 
            padding: 10px 20px; 
            border-radius: 8px; 
            font-weight: 700; 
            font-size: 13px; 
            cursor: pointer; 
            border: none; 
        }
        
        .main-btn { 
            width: 100%; 
            padding: 18px; 
            border-radius: 15px; 
            border: none; 
            background: var(--p); 
            color: #000; 
            font-weight: 800; 
            cursor: pointer; 
            font-size: 16px; 
            box-shadow: 0 8px 25px rgba(212, 255, 0, 0.4); 
        }
        .main-btn:active { transform: scale(0.98); }
        
        /* PENDING SCREEN */
        .pending-box { text-align: center; margin-top: 50px; }
        .pending-box i { font-size: 50px; color: var(--p); margin-bottom: 20px; }
        .pending-box h3 { font-size: 24px; margin: 10px 0; }
        .pending-box p { color: var(--text); font-size: 14px; line-height: 1.6; }
        
        /* QUIZ SCREEN */
        .top-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .info-card { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            padding: 15px; 
            border-radius: 15px; 
        }
        .info-card h4 { font-size: 12px; color: rgba(255,255,255,0.8); margin: 0 0 8px 0; }
        .info-card .value { font-size: 22px; color: white; font-weight: 800; }
        .info-card .sub { font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 5px; }
        
        .stats-mini { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .stat-box { 
            background: #151b2d; 
            padding: 10px; 
            border-radius: 12px; 
            text-align: center; 
            border: 1px solid #2a344d; 
        }
        .stat-box small { font-size: 10px; color: var(--text); display: block; margin-bottom: 5px; }
        .stat-box b { color: var(--p); font-size: 14px; }
        
        .question-card { 
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
            padding: 25px; 
            border-radius: 15px; 
            margin-bottom: 15px; 
            text-align: center; 
            min-height: 80px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .question-text { font-size: 18px; font-weight: 700; color: white; line-height: 1.4; }
        
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .opt-btn { 
            background: #1e263d; 
            border: 2px solid #3d4b6e; 
            padding: 18px 12px; 
            border-radius: 12px; 
            color: #fff; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s; 
            font-size: 14px;
        }
        .opt-btn:active { transform: scale(0.95); }
        .correct { background: #27ae60 !important; border-color: #2ecc71 !important; }
        .wrong { background: #c0392b !important; border-color: #e74c3c !important; }

        /* AD OVERLAY */
        #adBox { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.98); 
            z-index: 999; 
            display: none;
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
        }
        #adBox.show { display: flex !important; }
        #aT { color: var(--p); font-weight: bold; font-size: 24px; text-align: center; }
        #cB { 
            margin-top: 30px; 
            padding: 15px 50px; 
            background: var(--p); 
            border: none; 
            border-radius: 25px; 
            color: #000; 
            font-weight: bold; 
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 5px 20px rgba(212, 255, 0, 0.5);
        }
        #cB:active { transform: scale(0.95); }

        /* Loading animation */
        .loader { 
            border: 3px solid #2a344d; 
            border-top: 3px solid var(--p); 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<!-- REGISTRATION SCREEN -->
<div id="regS" class="screen">
    <div class="card">
        <div class="reg-header">
            <h1>ðŸ’Ž OFFICIAL MEMBERSHIP</h1>
            <p>Start Your Earning Journey Today</p>
        </div>
        <div class="info-box">
            <p>Fees: <b>Rs. 200</b> (Life Time)</p>
            <p>EasyPaisa: <b>03412049729</b></p>
            <p><b>Muhammad Hussain</b></p>
        </div>
        <input id="n" placeholder="Full Name" type="text">
        <input id="i" placeholder="Username / ID" type="text">
        <input id="trx" placeholder="Transaction ID (11 Digits)" type="text">
        <div class="file-box">
            <div class="file-info">
                <i class="fas fa-image"></i> 
                <span id="fileName">No file chosen</span>
            </div>
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">CHOOSE</button>
        </div>
        <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(this)">
        <button class="main-btn" onclick="submitRegistration()">ACTIVATE NOW</button>
    </div>
</div>

<!-- PENDING APPROVAL SCREEN -->
<div id="penS" class="screen">
    <div class="card pending-box">
        <i class="fas fa-clock"></i>
        <h3>Pending Approval</h3>
        <p>Your payment is under review.<br>Dashboard will open once admin approves.</p>
        <div class="loader"></div>
    </div>
</div>

<!-- QUIZ DASHBOARD SCREEN -->
<div id="quizS" class="screen">
    <div class="top-cards">
        <div class="info-card">
            <h4>Balance</h4>
            <div class="value" id="bal">0.00</div>
            <div class="sub">Level <span id="lvl">1</span></div>
        </div>
        <div class="info-card">
            <h4>Limit</h4>
            <div class="value" id="lim">0/200</div>
            <div class="sub">Questions</div>
        </div>
    </div>
    <div class="stats-mini">
        <div class="stat-box"><small>EARNED</small><b id="earned">0.00</b></div>
        <div class="stat-box"><small>DED.</small><b id="deducted">0.00</b></div>
        <div class="stat-box"><small>REWARD</small><b id="reward">0.40</b></div>
    </div>
    <div class="question-card">
        <div class="question-text" id="qT">Loading Questions...</div>
    </div>
    <div class="options-grid" id="qG"></div>
    <button class="main-btn" id="mB" onclick="handleAnswer()">SUBMIT ANSWER</button>
</div>

<!-- AD OVERLAY -->
<div id="adBox">
    <div id="aT">Ad Closing in 20s...</div>
    <button id="cB" onclick="closeAd()" style="display:none;">CLOSE AD</button>
</div>

<script>
    // =====================================================
    // CONFIGURATION
    // =====================================================
    const URL = "https://script.google.com/macros/s/AKfycbyD4XH_WPLQBnRyLxIGTLxhXJ0OY6cnZLQvNgrmIqkAC9RTMdtxgdEXG4h17uKz-sZhZQ/exec";
    const IMBB_KEY = "14d35273fb4122ebb999baa08057f3f0";
    
    // User data
    let userData = {
        id: null,
        earned: 0,
        deducted: 0,
        played: 0,
        referrals: 0,
        adCounter: 0
    };
    
    // Level configuration
    let levelConfig = { level: 1, reward: 0.40, penalty: 0.20 };
    let dailyLimit = 200;
    
    // Quiz data
    let questions = [];
    let currentQuestion = null;
    let selectedAnswer = null;

    // =====================================================
    // INITIALIZATION
    // =====================================================
    window.onload = function() {
        // Check if user ID exists in localStorage
        const savedID = localStorage.getItem("psID");
        
        if (savedID && savedID !== "null" && savedID !== "") {
            userData.id = savedID;
            checkUserStatus();
        } else {
            showScreen("regS");
        }
    };

    // =====================================================
    // SCREEN MANAGEMENT
    // =====================================================
    function showScreen(screenId) {
        // Hide all screens
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        
        // Show requested screen
        const targetScreen = document.getElementById(screenId);
        if (targetScreen) {
            targetScreen.classList.add('active');
        }
    }

    // =====================================================
    // USER STATUS CHECK
    // =====================================================
    async function checkUserStatus() {
        try {
            const response = await fetch(URL + "?checkID=" + encodeURIComponent(userData.id));
            const text = await response.text();
            
            // User not found in database
            if (text === "NotFound" || text.trim() === "NotFound") {
                localStorage.removeItem("psID");
                userData.id = null;
                showScreen("regS");
                return;
            }
            
            // Parse server response
            const data = JSON.parse(text);
            
            if (data.status === "Pending") {
                // Show pending screen
                showScreen("penS");
            } else if (data.status === "Approved") {
                // User is approved - load quiz dashboard
                userData.referrals = data.referrals || 0;
                setupQuizDashboard();
            } else {
                // Unknown status - show registration
                showScreen("regS");
            }
        } catch (error) {
            console.error("Status check error:", error);
            showScreen("regS");
        }
    }

    // =====================================================
    // REGISTRATION
    // =====================================================
    function handleFileSelect(input) {
        const file = input.files[0];
        if (file) {
            document.getElementById('fileName').textContent = file.name;
        }
    }

    async function submitRegistration() {
        const name = document.getElementById("n").value.trim();
        const userId = document.getElementById("i").value.trim();
        const transactionId = document.getElementById("trx").value.trim();
        const file = document.getElementById("fileInput").files[0];
        
        // Validation
        if (!name || !userId || !transactionId || !file) {
            Swal.fire("Error", "All fields are required!", "error");
            return;
        }
        
        // Show loading
        Swal.fire({
            title: 'Uploading...',
            text: 'Please wait',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });
        
        try {
            // Upload image to ImgBB
            const formData = new FormData();
            formData.append("image", file);
            
            const imgResponse = await fetch(`https://api.imgbb.com/1/upload?key=${IMBB_KEY}`, {
                method: "POST",
                body: formData
            });
            const imgData = await imgResponse.json();
            
            if (!imgData.data || !imgData.data.url) {
                throw new Error("Image upload failed");
            }
            
            // Submit to Google Sheets
            const submitData = {
                type: "reg",
                id: userId,
                name: name,
                trx: transactionId,
                proof: imgData.data.url
            };
            
            await fetch(URL, {
                method: "POST",
                body: JSON.stringify(submitData)
            });
            
            // Save user ID
            localStorage.setItem("psID", userId);
            userData.id = userId;
            
            // Show success and check status
            Swal.fire("Success!", "Account submitted for approval", "success").then(() => {
                checkUserStatus();
            });
            
        } catch (error) {
            console.error("Registration error:", error);
            Swal.fire("Error", error.message || "Registration failed", "error");
        }
    }

    // =====================================================
    // QUIZ DASHBOARD SETUP
    // =====================================================
    function setupQuizDashboard() {
        // Update level based on referrals
        if (userData.referrals >= 10) {
            levelConfig = { level: 3, reward: 0.60, penalty: 0.30 };
        } else if (userData.referrals >= 5) {
            levelConfig = { level: 2, reward: 0.50, penalty: 0.25 };
        }
        
        // Update daily limit
        dailyLimit = 200 + (userData.referrals * 50);
        
        // Update UI
        document.getElementById("reward").textContent = levelConfig.reward.toFixed(2);
        
        // Show quiz screen
        showScreen("quizS");
        
        // Load questions
        loadQuestions();
    }

    // =====================================================
    // LOAD QUESTIONS
    // =====================================================
    async function loadQuestions() {
        try {
            const response = await fetch(URL);
            const data = await response.json();
            
            questions = data.map(q => ({
                question: q.q,
                answers: q.a,
                correct: q.c
            }));
            
            if (questions.length > 0) {
                loadNextQuestion();
            } else {
                document.getElementById("qT").textContent = "No questions available";
            }
        } catch (error) {
            console.error("Failed to load questions:", error);
            document.getElementById("qT").textContent = "Error loading questions";
        }
    }

    // =====================================================
    // LOAD NEXT QUESTION
    // =====================================================
    function loadNextQuestion() {
        // Check daily limit
        if (userData.played >= dailyLimit) {
            Swal.fire("Limit Reached", "You have completed today's questions!", "info");
            return;
        }
        
        // Reset state
        selectedAnswer = null;
        document.getElementById("mB").textContent = "SUBMIT ANSWER";
        
        // Random question
        currentQuestion = questions[Math.floor(Math.random() * questions.length)];
        
        // Display question
        document.getElementById("qT").textContent = currentQuestion.question;
        
        // Display options
        let optionsHTML = "";
        currentQuestion.answers.forEach((answer, index) => {
            optionsHTML += `<button class="opt-btn" onclick="selectAnswer(${index}, this)">${answer}</button>`;
        });
        document.getElementById("qG").innerHTML = optionsHTML;
        
        // Update UI
        updateDashboard();
    }

    // =====================================================
    // SELECT ANSWER
    // =====================================================
    function selectAnswer(index, button) {
        // Prevent selection if showing results
        if (document.getElementById("mB").textContent === "NEXT") return;
        
        selectedAnswer = { index: index, button: button };
        
        // Reset all borders
        document.querySelectorAll(".opt-btn").forEach(btn => {
            btn.style.borderColor = "#3d4b6e";
        });
        
        // Highlight selected
        button.style.borderColor = "var(--p)";
    }

    // =====================================================
    // HANDLE ANSWER SUBMISSION
    // =====================================================
    function handleAnswer() {
        const submitBtn = document.getElementById("mB");
        
        // If showing "NEXT" - load next question
        if (submitBtn.textContent === "NEXT") {
            userData.played++;
            userData.adCounter++;
            
            // Show ad after every 10 questions
            if (userData.adCounter >= 10) {
                showAd();
            } else {
                loadNextQuestion();
            }
            return;
        }
        
        // Check if answer selected
        if (!selectedAnswer) {
            Swal.fire("", "Please select an answer", "warning");
            return;
        }
        
        // Check answer
        if (selectedAnswer.index === currentQuestion.correct) {
            // Correct answer
            selectedAnswer.button.classList.add("correct");
            userData.earned += levelConfig.reward;
        } else {
            // Wrong answer
            selectedAnswer.button.classList.add("wrong");
            userData.deducted += levelConfig.penalty;
            
            // Show correct answer
            document.querySelectorAll(".opt-btn")[currentQuestion.correct].classList.add("correct");
        }
        
        // Change button to NEXT
        submitBtn.textContent = "NEXT";
        updateDashboard();
    }

    // =====================================================
    // UPDATE DASHBOARD UI
    // =====================================================
    function updateDashboard() {
        const balance = userData.earned - userData.deducted;
        document.getElementById("bal").textContent = balance.toFixed(2);
        document.getElementById("earned").textContent = userData.earned.toFixed(2);
        document.getElementById("deducted").textContent = userData.deducted.toFixed(2);
        document.getElementById("lvl").textContent = levelConfig.level;
        document.getElementById("lim").textContent = userData.played + "/" + dailyLimit;
    }

    // =====================================================
    // AD SYSTEM
    // =====================================================
    function showAd() {
        const adBox = document.getElementById("adBox");
        const closeBtn = document.getElementById("cB");
        const adText = document.getElementById("aT");
        
        adBox.classList.add("show");
        closeBtn.style.display = "none";
        
        let seconds = 20;
        adText.textContent = `Ad Closing in ${seconds}s...`;
        
        const timer = setInterval(() => {
            seconds--;
            adText.textContent = `Ad Closing in ${seconds}s...`;
            
            if (seconds <= 0) {
                clearInterval(timer);
                closeBtn.style.display = "block";
            }
        }, 1000);
    }

    function closeAd() {
        const adBox = document.getElementById("adBox");
        const closeBtn = document.getElementById("cB");
        
        adBox.classList.remove("show");
        closeBtn.style.display = "none";
        userData.adCounter = 0;
        
        loadNextQuestion();
    }
</script>
</body>
</html>
